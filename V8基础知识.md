## string内存分配

简单测试脚本

```
var str1 = new String("aaaaaaaaaaaaaaa");
var str2 = new String("aaaaaaaaaaaaaaa");
var str3 = new String("bbbbbbbbbbbbbb");
var str4 = new String(null);
%DebugPrint(str1);
%DebugPrint(str2);
%DebugPrint(str3);
%DebugPrint(str4);
%SystemBreak();
```

四个字符串在内存中的表示如下：

```
gdb-peda$ job 0x10c97068a0f9
0x10c97068a0f9: [JSValue]
 - map = 0x3a8abb406981 [FastProperties]
 - prototype = 0x28248a2978c1
 - elements = 0x19cde9d02241 <FixedArray[0]> [FAST_STRING_WRAPPER_ELEMENTS]
 - value = 0x28248a2aaff9 <String[15]: aaaaaaaaaaaaaaa>
 - properties = {
   #length: 0x19cde9d56379 <AccessorInfo> (accessor constant)
 }
gdb-peda$ job 0x10c97068a119
0x10c97068a119: [JSValue]
 - map = 0x3a8abb406981 [FastProperties]
 - prototype = 0x28248a2978c1
 - elements = 0x19cde9d02241 <FixedArray[0]> [FAST_STRING_WRAPPER_ELEMENTS]
 - value = 0x28248a2aaff9 <String[15]: aaaaaaaaaaaaaaa>
 - properties = {
   #length: 0x19cde9d56379 <AccessorInfo> (accessor constant)
 }
gdb-peda$ job 0x10c97068a139
0x10c97068a139: [JSValue]
 - map = 0x3a8abb406981 [FastProperties]
 - prototype = 0x28248a2978c1
 - elements = 0x19cde9d02241 <FixedArray[0]> [FAST_STRING_WRAPPER_ELEMENTS]
 - value = 0x28248a2ab061 <String[14]: bbbbbbbbbbbbbb>
 - properties = {
   #length: 0x19cde9d56379 <AccessorInfo> (accessor constant)
 }
gdb-peda$ job 0x10c97068a159
0x10c97068a159: [JSValue]
 - map = 0x3a8abb406981 [FastProperties]
 - prototype = 0x28248a2978c1
 - elements = 0x19cde9d02241 <FixedArray[0]> [FAST_STRING_WRAPPER_ELEMENTS]
 - value = 0x19cde9d02251 <String[4]: null>
 - properties = {
   #length: 0x19cde9d56379 <AccessorInfo> (accessor constant)
 }

```
可以看到，JavaScript中的字符串也是个对象，其数据保存在value属性中。两个相同的字符串只会在内存中保存一次，保存的地方看起来是在堆栈上面，然后两个字符串对象的value指针指向同一个地址处。如果是null字符串，其value指针会指向跟elements指针相近的地方，看起来它们可能都是程序中定义的一个泛用型数据。字符串的value属性内存表示如下：
```
gdb-peda$ x/10xg 0x28248a2aaff9
0x28248a2aaff9:	0x92000034538f3023	0x00000000006548be
0x28248a2ab009:	0x610000000f000000	0x6161616161616161
0x28248a2ab019:	0x61de616161616161	0x1e000034538f3023
0x28248a2ab029:	0x0000000000754f70	0x7300000004000000
0x28248a2ab039:	0x61deadbeed327274	0xc6000034538f3023
```

第三个地址单元处以SMI类型存储了字符串长度，第四个地址单元开始就是字符串的数据，第一个地址单元打印出来可以看到是个Map，第二个地址单元只占用了低32位，是个不知名数据。

## 对象properties属性内存分配

```
var a = {};
a.a = 1;
a.b = 1.1;
a.c = {};
%DebugPrint(a);
%SystemBreak();
```

内存布局：
```
gdb-peda$ job 0x3be54d50a051
0x3be54d50a051: [JS_OBJECT_TYPE]
 - map = 0x31509260c3e9 [FastProperties]
 - prototype = 0x3c308684101
 - elements = 0x15f50f002241 <FixedArray[0]> [FAST_HOLEY_ELEMENTS]
 - properties = {
   #a: 1 (data field at offset 0)
   #b: <unboxed double> 1.1 (data field at offset 1)
   #c: 0x3be54d50a121 <an Object with map 0x315092603ac1> (data field at offset 2)
 }
gdb-peda$ x/10gx 0x3be54d50a050
0x3be54d50a050:	0x000031509260c3e9	0x000015f50f002241
0x3be54d50a060:	0x000015f50f002241	0x0000000100000000
0x3be54d50a070:	0x3ff199999999999a	0x00003be54d50a121
0x3be54d50a080:	0x000015f50f002311	0x0000318042484099
0x3be54d50a090:	0x000003c3086ab459	0x0000318042482309

```
可以看到，对于{}这种字典型对象来说，此时其properties就直接布置在了对象的后方，和对象紧贴，并按照SMI、Double、Object等类型进行存放。

换一种代码：

```
var a = new Set();
a.a = 1;
a.b = 1.1;
a.c = {};
%DebugPrint(a);
%SystemBreak();
```
```
gdb-peda$ job 0x398ee78a059
0x398ee78a059: [JSSet]
 - map = 0x20b84410c3e9 [FastProperties]
 - prototype = 0xe2f8a95e49
 - elements = 0x278d96602241 <FixedArray[0]> [FAST_HOLEY_SMI_ELEMENTS] - table = 0x398ee78a079 <FixedArray[13]>
 - properties = {
   #a: 1 (data field at offset 0)
   #b: 0x398ee78a1a1 <MutableNumber: 1.1> (data field at offset 1)
   #c: 0x398ee78a1b1 <an Object with map 0x20b844103ac1> (data field at offset 2)
 }
gdb-peda$ x/10gx 0x398ee78a058
0x398ee78a058:	0x000020b84410c3e9	0x00000398ee78a129
0x398ee78a068:	0x0000278d96602241	0x00000398ee78a079
0x398ee78a078:	0x00000a5d20602f11	0x0000000d00000000
0x398ee78a088:	0x0000000200000000	0x0000000000000000
0x398ee78a098:	0x0000000000000000	0xffffffff00000000
gdb-peda$ job 0x00000398ee78a129
0x398ee78a129: [FixedArray]
 - length: 3
  [0]: 1
  [1]: 0x398ee78a1a1 <MutableNumber: 1.1>
  [2]: 0x398ee78a1b1 <an Object with map 0x20b844103ac1>
gdb-peda$ x/10gx 0x00000398ee78a128
0x398ee78a128:	0x00000a5d20602309	0x0000000300000000
0x398ee78a138:	0x0000000100000000	0x00000398ee78a1a1
0x398ee78a148:	0x00000398ee78a1b1	0x00000a5d20602309
0x398ee78a158:	0x0000000800000000	0x0000000200000000
0x398ee78a168:	0x0000000000000000	0x0000278d96608499

```
可以看到，对于Set这种非字典型对象来说，此时其properties属性是一个保存在第二个地址单元处的指针，我们定义的这些properties都会放置在这个指针指向的地址处。在该处地址，第一个地址单元存放Map，第二个地址单元存放properties数量，第三个地址单元开始存放properties，SMI直接存放，Double和对象存放的是地址。

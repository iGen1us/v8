# V8基础知识

## 基本类型在内存中的存储

首先是几个基础类型，包括整型（Smi/immediate small integer）、浮点数（Double）及指针（Pointers），在内存中保存的形态，按照参考文章中的描述：

```
Double: Shown as the 64-bit binary representation without any changes
Smi: Represented as value << 32, i.e 0xdeadbeef is represented as 0xdeadbeef00000000
Pointers: Represented as addr & 1. 0x2233ad9c2ed8 is represented as 0x2233ad9c2ed9
```

为了区分数字和指针指向的地址，v8将地址的最低位置为1，所以指针指向的地址-1才是该对象在内存中的真正地址。

## gdb调试

### --allow-natives-syntax：

主要定义了两个调试用函数：

- %DebugPrint(a)，用于打印对象地址
- %SystemBreak()，相当于断点

### job

将JavaScript对象在内存中的数据打印成可视形态

### telescope

将某处地址处的数据打印出来

一个对象的内存中的前三个部分分别为：map属性，properties属性（对象成员保存在这里）和elements属性（数组成员保存在这里）

elements属性的三个部分分别是：map属性、成员数量和成员

## 类型辨认

我们可以注意到，我们使用job命令读取一个地址时可以将其可视化打印成相应的数字或者对象，其中必定经过了类型辨认的阶段。

整型很好辨认，其低32位全是0，浮点数和对象的辨认就需要依靠他们的map属性了。

如果对象中的成员全是数字（整型/浮点数），那就不需要每个成员都带一个map属性，再用指针来表示了。

当成员中存在对象时，指针会指向该成员的map属性。（浮点数变成map+浮点的存储形式，对象不变）

## string内存分配

简单测试脚本

```
var str1 = new String("aaaaaaaaaaaaaaa");
var str2 = new String("aaaaaaaaaaaaaaa");
var str3 = new String("bbbbbbbbbbbbbb");
var str4 = new String(null);
%DebugPrint(str1);
%DebugPrint(str2);
%DebugPrint(str3);
%DebugPrint(str4);
%SystemBreak();
```

四个字符串在内存中的表示如下：

![image-20210521103449778](C:\Users\Hide\AppData\Roaming\Typora\typora-user-images\image-20210521103449778.png)

可以看到，JavaScript中的字符串也是个对象，其数据保存在value属性中。两个相同的字符串只会在内存中保存一次，保存的地方看起来是在堆栈上面，然后两个字符串对象的value指针指向同一个地址处。如果是null字符串，其value指针会指向跟elements指针相近的地方，看起来它们可能都是程序中定义的一个泛用型数据。字符串的value属性内存表示如下：

![image-20210521103604207](C:\Users\Hide\AppData\Roaming\Typora\typora-user-images\image-20210521103604207.png)

第三个地址单元处以SMI类型存储了字符串长度，第四个地址单元开始就是字符串的数据，第一个地址单元打印出来可以看到是个Map，第二个地址单元只占用了低32位，是个不知名数据。

## 对象properties属性内存分配

```
var a = {};
a.a = 1;
a.b = 1.1;
a.c = {};
%DebugPrint(a);
%SystemBreak();
```

内存布局：

![image-20210521104322545](C:\Users\Hide\AppData\Roaming\Typora\typora-user-images\image-20210521104322545.png)

可以看到，对于{}这种字典型对象来说，此时其properties就直接布置在了对象的后方，和对象紧贴，并按照SMI、Double、Object等类型进行存放。

换一种代码：

```
var a = new Set();
a.a = 1;
a.b = 1.1;
a.c = {};
%DebugPrint(a);
%SystemBreak();
```

![image-20210521104613612](C:\Users\Hide\AppData\Roaming\Typora\typora-user-images\image-20210521104613612.png)

可以看到，对于Set这种非字典型对象来说，此时其properties属性是一个保存在第二个地址单元处的指针，我们定义的这些properties都会放置在这个指针指向的地址处。在该处地址，第一个地址单元存放Map，第二个地址单元存放properties数量，第三个地址单元开始存放properties，SMI直接存放，Double和对象存放的是地址。
